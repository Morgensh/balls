<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Planet Conquest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .pixel {
            transition: fill 0.1s ease;
        }
      
        .pixel.conquered {
            animation: pixel-flash 0.3s ease-out;
        }
      
        @keyframes pixel-flash {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(2) drop-shadow(0 0 3px #fff);
            }
        }
      
        .country {
            stroke: #2c3e50;
            stroke-width: 0.5;
            cursor: pointer;
        }
      
        .country.neutral {
            fill: #1a2535;
        }
      
        .country.player {
            fill: #ff6b6b;
        }
      
        .country.warring {
            fill: none;
        }
      
        .country:hover {
            stroke: #fff;
            stroke-width: 2;
        }
      
        .country.target {
            stroke: #ff0000;
            stroke-width: 3;
            filter: drop-shadow(0 0 10px #ff0000);
        }
      
        .ocean {
            fill: #0a0d15;
        }
      
        .glow-text {
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
        }
      
        .pulse {
            animation: pulse 2s infinite;
        }
      
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-white">
    <div id="start-menu" class="fixed inset-0 bg-gradient-to-br from-gray-900 to-gray-800 flex flex-col items-center justify-center z-50">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 glow-text">üåç Pixel Planet Conquest</h1>
        <p class="text-gray-300 mb-4 text-center max-w-md">–ó–∞–≤–æ—é–π—Ç–µ –º–∏—Ä –ø–æ –æ–¥–Ω–æ–º—É –ø–∏–∫—Å–µ–ª—é –∑–∞ —Ä–∞–∑! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω—É –∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–≤–æ–µ–≤–∞–Ω–∏–µ.</p>
        <select id="start-country" class="bg-gray-700 border-2 border-gray-500 text-white px-4 py-2 rounded-lg mb-4 w-64">
            <!-- Options will be populated dynamically -->
        </select>
        <button id="start-btn" class="bg-green-600 hover:bg-green-500 border-2 border-green-400 text-white px-6 py-3 rounded-lg font-bold transition-all">
            <i data-feather="play" class="inline mr-2"></i> –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
        </button>
    </div>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 glow-text">üåç Pixel Planet Conquest</h1>
            <p class="text-gray-300">–ó–∞–≤–æ—é–π—Ç–µ –º–∏—Ä –ø–æ –æ–¥–Ω–æ–º—É –ø–∏–∫—Å–µ–ª—é –∑–∞ —Ä–∞–∑!</p>
        </div>
      
        <div id="game-controls" class="bg-gray-800 rounded-xl border-2 border-gray-700 shadow-xl mb-8 p-6 hidden">
            <div id="info-text" class="bg-blue-900/20 border border-blue-500 rounded-lg p-3 text-center text-blue-200 mb-4">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–≤–æ–µ–≤–∞–Ω–∏—è –º–∏—Ä–∞! üåç
            </div>
          
            <div class="flex flex-wrap justify-center gap-3 mb-4">
                <button id="attack-btn" onclick="attackCountryAction()" disabled class="bg-red-600 hover:bg-red-500 border-2 border-red-400 text-white px-6 py-2 rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-feather="zap" class="inline mr-2"></i> –ê–¢–ê–ö–û–í–ê–¢–¨
                </button>
                <button id="cancel-btn" onclick="cancelSelection()" disabled class="bg-gray-600 hover:bg-gray-500 border-2 border-gray-400 text-white px-6 py-2 rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-feather="x" class="inline mr-2"></i> –û–¢–ú–ï–ù–ê
                </button>
            </div>
        </div>
      
        <div id="world-map" class="w-full bg-gray-900 rounded-xl border-2 border-gray-700 shadow-2xl mb-8 relative overflow-hidden hidden"></div>
      
        <div id="bottom-buttons" class="flex flex-wrap justify-center gap-4 hidden">
            <button onclick="resetGame()" class="bg-purple-600 hover:bg-purple-500 border-2 border-purple-400 text-white px-6 py-3 rounded-lg font-bold transition-all">
                <i data-feather="refresh-cw" class="inline mr-2"></i> –ù–û–í–ê–Ø –ò–ì–†–ê
            </button>
            <button onclick="toggleSpeed()" class="bg-yellow-600 hover:bg-yellow-500 border-2 border-yellow-400 text-white px-6 py-3 rounded-lg font-bold transition-all">
                <i data-feather="clock" class="inline mr-2"></i> –°–ö–û–†–û–°–¢–¨: <span id="speed-text">–°–†–ï–î–ù–Ø–Ø</span>
            </button>
            <button onclick="resetZoom()" class="bg-blue-600 hover:bg-blue-500 border-2 border-blue-400 text-white px-6 py-3 rounded-lg font-bold transition-all">
                <i data-feather="zoom-out" class="inline mr-2"></i> –°–ë–†–û–° –ó–£–ú–ê
            </button>
        </div>
    </div>
    <script>
        const width = 1360;
        const height = 600;
        const pixelSize = 4;
      
        let countriesData = [];
        let hoveredCountry = null;
        let targetCountry = null;
        let countryOwners = {};
        let countryPixels = {};
        let svg, g, pixelLayer, countryLayer;
        let warInProgress = false;
        let gameSpeed = 40;
        const speeds = {slow: 80, medium: 40, fast: 15};
        let currentSpeed = 'medium';
        let idToGeoIndex = {};
        let geoNeighbors = [];
      
        const projection = d3.geoNaturalEarth1()
            .scale(width / 6.5)
            .translate([width / 2, height / 2]);
        const path = d3.geoPath().projection(projection);
        function initMap() {
            svg = d3.select("#world-map")
                .append("svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("width", "100%")
                .attr("height", "100%");
              
            const zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on('zoom', zoomed);
              
            svg.call(zoom);
              
            g = svg.append("g");
              
            g.append("path")
                .datum({type: "Sphere"})
                .attr("class", "ocean")
                .attr("d", path);
              
            pixelLayer = g.append("g").attr("class", "pixel-layer");
            countryLayer = g.append("g").attr("class", "country-layer");
          
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(function(world) {
                const originalGeometries = world.objects.countries.geometries;
                geoNeighbors = topojson.neighbors(originalGeometries);
                originalGeometries.forEach((geo, i) => {
                    idToGeoIndex[geo.id] = i;
                });
              
                const countries = topojson.feature(world, world.objects.countries);
                countriesData = countries.features;
              
                // Sort countries alphabetically by name
                countriesData.sort((a, b) => a.properties.name.localeCompare(b.properties.name));
              
                // Populate start country select
                const select = document.getElementById('start-country');
                countriesData.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.textContent = country.properties.name;
                    select.appendChild(option);
                });
              
                countriesData.forEach(country => {
                    countryOwners[country.id] = 'neutral';
                    countryPixels[country.id] = createPixelsForCountry(country);
                });
              
                countryLayer.selectAll(".country")
                    .data(countriesData)
                    .enter()
                    .append("path")
                    .attr("class", "country")
                    .attr("d", path)
                    .attr("data-id", d => d.id)
                    .classed("neutral", true)
                    .on("click", handleCountryClick)
                    .on("mouseover", handleCountryHover)
                    .append("title")
                    .text(d => d.properties.name);
            });

            adjustLayout();
            window.addEventListener('resize', adjustLayout);
        }
        function adjustLayout() {
            const isPortrait = window.innerWidth < window.innerHeight;
            const container = document.getElementById('world-map');
            if (isPortrait) {
                container.style.aspectRatio = 'auto';
                container.style.height = '60vh';
                svg.attr('preserveAspectRatio', 'xMidYMid slice');
            } else {
                container.style.aspectRatio = '1360 / 600';
                container.style.height = 'auto';
                svg.attr('preserveAspectRatio', 'xMidYMid meet');
            }
        }
        function zoomed(event) {
            g.attr('transform', event.transform);
        }
        function resetZoom() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity,
                d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
            );
        }
        function createPixelsForCountry(country) {
            const bounds = path.bounds(country);
            const pixels = [];
          
            for (let x = Math.floor(bounds[0][0]); x < bounds[1][0]; x += pixelSize) {
                for (let y = Math.floor(bounds[0][1]); y < bounds[1][1]; y += pixelSize) {
                    const point = [x + pixelSize/2, y + pixelSize/2];
                    const coords = projection.invert(point);
                  
                    if (coords && d3.geoContains(country, coords)) {
                        pixels.push({
                            x: x,
                            y: y,
                            owner: 'neutral',
                            element: null
                        });
                    }
                }
            }
          
            pixels.forEach(pixel => {
                const rect = pixelLayer.append("rect")
                    .attr("class", "pixel")
                    .attr("x", pixel.x)
                    .attr("y", pixel.y)
                    .attr("width", pixelSize)
                    .attr("height", pixelSize)
                    .attr("fill", "transparent")
                    .attr("stroke", "none");
                pixel.element = rect;
            });
          
            return pixels;
        }
        function handleCountryHover(event, country) {
            if (warInProgress) return;
          
            hoveredCountry = country;
            const ownerText = countryOwners[country.id] === 'player' ? '–í–∞—à–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è';
            let extra = '';
            if (countryOwners[country.id] === 'neutral') {
                const hasNeighbor = getPlayerCountries().some(pc => isNeighbor(pc, country));
                extra = hasNeighbor ? ' (–º–æ–∂–Ω–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å)' : ' (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)';
            }
            updateInfoText(`–ù–∞–≤–µ–¥–µ–Ω–æ: ${country.properties.name} (${ownerText}${extra})`);
            updateButtons();
        }
        function handleCountryClick(event, country) {
            if (warInProgress) return;
          
            hoveredCountry = country;
            countryLayer.selectAll(".country").classed('target', false);
          
            if (countryOwners[country.id] === 'player') {
                updateInfoText(`–í–∞—à–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è: ${country.properties.name}`);
            } else if (countryOwners[country.id] === 'neutral') {
                const hasNeighbor = getPlayerCountries().some(pc => isNeighbor(pc, country));
                if (hasNeighbor) {
                    targetCountry = country;
                    countryLayer.select(`path[data-id="${targetCountry.id}"]`).classed('target', true);
                    updateInfoText(`–¶–µ–ª—å: ${country.properties.name}. –ù–∞–∂–º–∏—Ç–µ "–ê–¢–ê–ö–û–í–ê–¢–¨" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤–æ–π–Ω—É! üí•`);
                } else {
                    updateInfoText(`‚ùå ${country.properties.name} –Ω–µ –≥—Ä–∞–Ω–∏—á–∏—Ç —Å –≤–∞—à–∏–º–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º–∏!`);
                }
            }
          
            updateButtons();
        }
        function attackCountryAction() {
            if (!targetCountry || warInProgress) return;
          
            startWar(targetCountry);
        }
        function cancelSelection() {
            if (warInProgress) return;
          
            if (targetCountry) {
                countryLayer.select(`path[data-id="${targetCountry.id}"]`).classed('target', false);
            }
            targetCountry = null;
            hoveredCountry = null;
            updateInfoText('–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –∑–∞–Ω–æ–≤–æ! üîÑ');
            updateButtons();
        }
        function updateButtons() {
            const attackBtn = document.getElementById('attack-btn');
            const cancelBtn = document.getElementById('cancel-btn');
          
            attackBtn.disabled = !targetCountry || warInProgress;
            cancelBtn.disabled = !targetCountry || warInProgress;
          
            // Add pulse effect to attack button when ready
            if (!attackBtn.disabled) {
                attackBtn.classList.add('pulse');
            } else {
                attackBtn.classList.remove('pulse');
            }
        }
        function startWar(defender) {
            warInProgress = true;
            updateButtons();
            updateInfoText(`‚öîÔ∏è –í–û–ô–ù–ê! –ê—Ç–∞–∫–∞ –Ω–∞ ${defender.properties.name}! –ó–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –∑–∞ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–º...`);
          
            countryLayer.select(`path[data-id="${defender.id}"]`).classed('neutral', false).classed('warring', true);
            const defenderPixels = countryPixels[defender.id];
            defenderPixels.forEach(p => {
                p.element.attr('fill', '#1a2535');
                p.owner = 'neutral';
            });
          
            const playerCountries = getPlayerCountries();
            const borderingPlayers = playerCountries.filter(pc => isNeighbor(pc, defender));
          
            let attackerBorder = [];
            borderingPlayers.forEach(bp => {
                attackerBorder.push(...countryPixels[bp.id]);
            });
          
            let capturedCount = 0;
            const totalPixels = defenderPixels.length;
          
            const warInterval = setInterval(() => {
                const uncapturedPixels = defenderPixels.filter(p => p.owner === 'neutral');
              
                if (uncapturedPixels.length === 0) {
                    clearInterval(warInterval);
                    countryOwners[defender.id] = 'player';
                    countryLayer.select(`path[data-id="${defender.id}"]`).classed('warring', false).classed('player', true);
                    defenderPixels.forEach(p => {
                        p.element.attr('fill', 'transparent');
                    });
                  
                    updateInfoText(`üéâ –ü–û–ë–ï–î–ê! ${defender.properties.name} –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ö–≤–∞—á–µ–Ω–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∑–∞–≤–æ–µ–≤–∞–Ω–∏–µ! üåç`);
                  
                    if (targetCountry) {
                        countryLayer.select(`path[data-id="${targetCountry.id}"]`).classed('target', false);
                    }
                    targetCountry = null;
                    warInProgress = false;
                    checkWinCondition();
                    updateButtons();
                    return;
                }
              
                const pixelsToCapture = Math.min(3 + borderingPlayers.length, uncapturedPixels.length); // Improved: faster with more borders
              
                for (let i = 0; i < pixelsToCapture; i++) {
                    let targetPixel;
                  
                    const borderPixels = uncapturedPixels.filter(p => {
                        return attackerBorder.some(ap => {
                            const dist = Math.sqrt(Math.pow(ap.x - p.x, 2) + Math.pow(ap.y - p.y, 2));
                            return dist < pixelSize * 3;
                        });
                    });
                  
                    if (borderPixels.length > 0) {
                        targetPixel = borderPixels[Math.floor(Math.random() * borderPixels.length)];
                    } else {
                        targetPixel = uncapturedPixels[Math.floor(Math.random() * uncapturedPixels.length)];
                    }
                  
                    targetPixel.owner = 'player';
                    targetPixel.element
                        .attr('fill', '#ff6b6b')
                        .classed('conquered', true);
                    setTimeout(() => targetPixel.element.classed('conquered', false), 300);
                  
                    attackerBorder.push(targetPixel);
                    capturedCount++;
                }
              
                const progress = Math.floor((capturedCount / totalPixels) * 100);
                updateInfoText(`‚öîÔ∏è –í–û–ô–ù–ê! –ó–∞—Ö–≤–∞—á–µ–Ω–æ: ${progress}%`);
              
            }, gameSpeed);
        }
        function isNeighbor(country1, country2) {
            const index1 = idToGeoIndex[country1.id];
            const index2 = idToGeoIndex[country2.id];
            return geoNeighbors[index1].includes(index2);
        }
        function getPlayerCountries() {
            return countriesData.filter(c => countryOwners[c.id] === 'player');
        }
        function updateInfoText(text) {
            document.getElementById('info-text').textContent = text;
        }
        function checkWinCondition() {
            const neutralCount = Object.values(countryOwners).filter(o => o === 'neutral').length;
            if (neutralCount === 0) {
                setTimeout(() => {
                    updateInfoText('üèÜ –ü–û–õ–ù–ê–Ø –ü–û–ë–ï–î–ê! –í—ã –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –≤—Å–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –º–∏—Ä–∞!');
                  
                    // Confetti celebration
                    const confettiSettings = { target: 'world-map', max: 200, size: 2, animate: true };
                    const confetti = new ConfettiGenerator(confettiSettings);
                    confetti.render();
                  
                    setTimeout(() => confetti.clear(), 5000);
                }, 500);
            }
        }
        function toggleSpeed() {
            if (currentSpeed === 'medium') {
                currentSpeed = 'fast';
                gameSpeed = speeds.fast;
            } else if (currentSpeed === 'fast') {
                currentSpeed = 'slow';
                gameSpeed = speeds.slow;
            } else {
                currentSpeed = 'medium';
                gameSpeed = speeds.medium;
            }
          
            document.getElementById('speed-text').textContent = currentSpeed === 'slow' ? '–ú–ï–î–õ–ï–ù–ù–ê–Ø' : (currentSpeed === 'fast' ? '–ë–´–°–¢–†–ê–Ø' : '–°–†–ï–î–ù–Ø–Ø');
        }
        function resetGame() {
            if (warInProgress) return;
          
            Object.keys(countryOwners).forEach(id => {
                countryOwners[id] = 'neutral';
                const pixels = countryPixels[id];
                pixels.forEach(pixel => {
                    pixel.owner = 'neutral';
                    pixel.element.attr('fill', 'transparent');
                });
                countryLayer.select(`path[data-id="${id}"]`)
                    .classed('player', false)
                    .classed('warring', false)
                    .classed('neutral', true)
                    .classed('target', false);
            });
          
            targetCountry = null;
            hoveredCountry = null;
            updateButtons();
            updateInfoText('–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞! –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–≤–æ–µ–≤–∞–Ω–∏—è! üåç');
          
            // Show start menu again
            document.getElementById('start-menu').style.display = 'flex';
            document.getElementById('game-controls').classList.add('hidden');
            document.getElementById('world-map').classList.add('hidden');
            document.getElementById('bottom-buttons').classList.add('hidden');
        }
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            feather.replace();
          
            // Load confetti script if needed
            if (!window.ConfettiGenerator) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js';
                document.head.appendChild(script);
            }
          
            // Start button handler
            document.getElementById('start-btn').addEventListener('click', function() {
                const startId = document.getElementById('start-country').value;
                if (!startId) return;
              
                const startCountry = countriesData.find(c => c.id === startId);
                countryOwners[startId] = 'player';
                countryLayer.select(`path[data-id="${startId}"]`).classed('neutral', false).classed('player', true);
              
                document.getElementById('start-menu').style.display = 'none';
                document.getElementById('game-controls').classList.remove('hidden');
                document.getElementById('world-map').classList.remove('hidden');
                document.getElementById('bottom-buttons').classList.remove('hidden');
              
                updateInfoText(`–ù–∞—á–∞–ª–∏ —Å ${startCountry.properties.name}! –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–æ—Å–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω—É –¥–ª—è –∞—Ç–∞–∫–∏. üó°Ô∏è`);
                adjustLayout();
            });
        });
    </script>
</body>
</html>
